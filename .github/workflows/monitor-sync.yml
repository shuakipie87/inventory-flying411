name: Sync to Pipeline Monitor

on:
  workflow_run:
    workflows:
      - "CI Pipeline"
      - "CD Pipeline"
      - "PR Quality Check"
      - "Security Scan"
      - "Release"
    types:
      - requested
      - in_progress
      - completed

permissions:
  actions: read

jobs:
  sync:
    name: Sync Pipeline Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # NOTE: secrets cannot be used in job-level if conditions (they always evaluate to true).
    # Instead, each step checks for the webhook URL at runtime via environment variables.
    steps:
      - name: Send Pipeline Data to Monitor
        uses: actions/github-script@v7
        env:
          MONITOR_URL: ${{ secrets.MONITOR_WEBHOOK_URL }}
        with:
          script: |
            const run = context.payload.workflow_run;
            if (!process.env.MONITOR_URL) return;

            const payload = {
              event: 'workflow_run',
              action: context.payload.action,
              workflow_run: {
                id: run.id,
                name: run.name,
                status: run.status,
                conclusion: run.conclusion,
                run_number: run.run_number,
                html_url: run.html_url,
                created_at: run.created_at,
                updated_at: run.updated_at,
                run_started_at: run.run_started_at,
                head_branch: run.head_branch,
                head_sha: run.head_sha,
                event: run.event,
                actor: {
                  login: run.actor?.login,
                  avatar_url: run.actor?.avatar_url
                },
                pull_requests: run.pull_requests,
                repository: {
                  full_name: run.repository?.full_name
                }
              }
            };

            await fetch(process.env.MONITOR_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-GitHub-Event': 'workflow_run',
                'X-GitHub-Delivery': String(run.id)
              },
              body: JSON.stringify(payload)
            }).catch(() => {});

      - name: Fetch Job Details
        if: github.event.action == 'completed'
        uses: actions/github-script@v7
        env:
          MONITOR_URL: ${{ secrets.MONITOR_WEBHOOK_URL }}
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            const jobData = jobs.data.jobs.map(job => ({
              id: job.id,
              name: job.name,
              status: job.status,
              conclusion: job.conclusion,
              started_at: job.started_at,
              completed_at: job.completed_at,
              steps: job.steps?.map(step => ({
                name: step.name,
                status: step.status,
                conclusion: step.conclusion,
                number: step.number
              }))
            }));

            if (!process.env.MONITOR_URL) return;
            await fetch(process.env.MONITOR_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                event: 'workflow_jobs',
                run_id: context.payload.workflow_run.id,
                jobs: jobData
              })
            }).catch(() => {});
